name: Reusable workflow - Cleanup gh-pages

on:
  workflow_call:

concurrency:
  group: gh-pages-${{ github.ref }}

jobs:
  cleanup-gh-pages:
    name: Cleanup gh-pages
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v3
        with:
          ref: gh-pages

      - name: Cleanup reports folder
        shell: bash
        env:
          BRANCH_NAME: ${{ github.head_ref }}
        run: |
          echo "reports/$BRANCH_NAME";

          if [ -d "reports/$BRANCH_NAME" ]; then
            rm -rf -- "reports/$BRANCH_NAME"
            
            git config user.name github-actions
            git config user.email github-actions@github.com

            git status
            git add reports/*
            git commit --amend -am "Deleting $BRANCH_NAME directory." || true
            
            while !(git push --force-with-lease)
            do
              echo "Resetting last commit"
              git reset --soft HEAD@{1}
              echo "Stashing staged changes"
              git stash
              echo "Rebasing"
              git pull --rebase
              echo "Applying stash"
              git stash pop
              echo "Staging changes"
              git add reports/*
              echo "Committing changes"
              git commit --amend -am "Deleting $BRANCH_NAME directory." || true
            done
          else
            echo "$BRANCH_NAME directory does not exists."
          fi
